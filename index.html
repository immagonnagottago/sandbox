<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Grass Sandbox</title>
<style>
body { margin: 0; overflow: hidden; }
canvas { display: block; }
</style>
</head>
<body>

<script type="module">

import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { PointerLockControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

// Scene
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

// Camera
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

// Renderer
const renderer = new THREE.WebGLRenderer({antialias: true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Light
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(50,100,50);
scene.add(light);

// Controls
const controls = new PointerLockControls(camera, document.body);
document.body.addEventListener("click", ()=>controls.lock());
scene.add(controls.getObject());
controls.getObject().position.y = 5;

// Movement
let velocity = new THREE.Vector3();
let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
let canJump = false;
const gravity = 20;
const playerHeight = 2;

document.addEventListener("keydown", (e)=>{
    switch(e.code){
        case "KeyW": moveForward = true; break;
        case "KeyS": moveBackward = true; break;
        case "KeyA": moveLeft = true; break;
        case "KeyD": moveRight = true; break;
        case "Space":
            if(canJump){ velocity.y = 10; canJump = false; }
            break;
    }
});
document.addEventListener("keyup", (e)=>{
    switch(e.code){
        case "KeyW": moveForward = false; break;
        case "KeyS": moveBackward = false; break;
        case "KeyA": moveLeft = false; break;
        case "KeyD": moveRight = false; break;
    }
});

// Terrain
const terrainSize = 100;
const terrainSegments = 128;
const terrainGeo = new THREE.PlaneGeometry(terrainSize, terrainSize, terrainSegments, terrainSegments);
terrainGeo.rotateX(-Math.PI/2);

for(let i=0;i<terrainGeo.attributes.position.count;i++){
    let x = terrainGeo.attributes.position.getX(i);
    let z = terrainGeo.attributes.position.getZ(i);
    let y = Math.sin(x*0.1)*2 + Math.cos(z*0.1)*2;
    terrainGeo.attributes.position.setY(i, y);
}
terrainGeo.computeVertexNormals();

const terrainMat = new THREE.MeshStandardMaterial({color:0x228B22});
const terrain = new THREE.Mesh(terrainGeo, terrainMat);
scene.add(terrain);

// Grass blocks
const grassBlocks = [];
const blockGeo = new THREE.BoxGeometry(1,1,1);
const blockMat = new THREE.MeshStandardMaterial({color:0x2ecc40});
const raycaster = new THREE.Raycaster();

// Place / break blocks
window.addEventListener("mousedown",(event)=>{
    raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
    const intersects = raycaster.intersectObjects([terrain, ...grassBlocks]);
    if(intersects.length > 0){
        const hit = intersects[0];
        if(event.button===0){ // break
            if(grassBlocks.includes(hit.object)){
                scene.remove(hit.object);
                grassBlocks.splice(grassBlocks.indexOf(hit.object),1);
            }
        }
        if(event.button===2){ // place
            const pos = hit.point.clone().add(hit.face.normal);
            pos.x = Math.round(pos.x);
            pos.y = Math.round(pos.y);
            pos.z = Math.round(pos.z);
            const block = new THREE.Mesh(blockGeo, blockMat);
            block.position.copy(pos);
            scene.add(block);
            grassBlocks.push(block);
        }
    }
});
window.addEventListener("contextmenu", e=>e.preventDefault());

// Terrain height
function getHeightAt(x,z){ return Math.sin(x*0.1)*2 + Math.cos(z*0.1)*2; }

// Animation
let prevTime = performance.now();
function animate(){
    requestAnimationFrame(animate);

    const time = performance.now();
    const delta = (time - prevTime)/1000;

    velocity.y -= gravity*delta;

    let direction = new THREE.Vector3();
    direction.z = Number(moveForward)-Number(moveBackward);
    direction.x = Number(moveRight)-Number(moveLeft);
    direction.normalize();

    if(moveForward || moveBackward) velocity.z -= direction.z*50*delta;
    if(moveLeft || moveRight) velocity.x -= direction.x*50*delta;

    controls.moveRight(-velocity.x*delta);
    controls.moveForward(-velocity.z*delta);

    controls.getObject().position.y += velocity.y*delta;
    const groundHeight = getHeightAt(controls.getObject().position.x, controls.getObject().position.z)+playerHeight;
    if(controls.getObject().position.y < groundHeight){
        velocity.y=0;
        controls.getObject().position.y=groundHeight;
        canJump=true;
    }

    velocity.x -= velocity.x*10*delta;
    velocity.z -= velocity.z*10*delta;

    prevTime=time;
    renderer.render(scene,camera);
}
animate();

</script>

</body>
</html>
